<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—ªçƒé—®é¢˜è¯Šæ–­å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 2rem;
        }
        .log-entry {
            padding: 0.5rem;
            border-left: 3px solid #00ff00;
            margin-bottom: 0.5rem;
            background: #2a2a2a;
        }
        .error { border-left-color: #ff0000; color: #ff6b6b; }
        .warning { border-left-color: #ffaa00; color: #ffd93d; }
        .success { border-left-color: #00ff00; color: #6bcf7f; }
        .info { border-left-color: #00aaff; color: #6bb6ff; }
        
        /* Test area with NO transitions */
        .test-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin: 1rem 0;
        }
        .test-img {
            width: 100%;
            height: 200px;
            background: #e5e7eb;
        }
        .test-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* NO transitions or animations */
            transition: none !important;
            animation: none !important;
            opacity: 1 !important;
        }
        .test-date {
            padding: 1rem;
            color: #666;
            /* NO transitions */
            transition: none !important;
            animation: none !important;
        }
    </style>
</head>
<body>
    <h1 class="text-3xl mb-4">ğŸ” é—ªçƒé—®é¢˜è¯Šæ–­å·¥å…·</h1>
    
    <div class="mb-4">
        <button onclick="runDiagnostics()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
            è¿è¡Œè¯Šæ–­
        </button>
        <button onclick="testImages()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 ml-2">
            æµ‹è¯•å›¾ç‰‡åŠ è½½
        </button>
        <button onclick="clearLogs()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 ml-2">
            æ¸…é™¤æ—¥å¿—
        </button>
    </div>

    <div id="logs" class="mb-4"></div>
    
    <div id="test-area"></div>

    <script type="module">
        import { ConferencesAPI } from './frontend/js/api-client.js';
        import { formatDateRange } from './frontend/js/timezone-utils.js';

        window.log = function(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        };

        window.clearLogs = function() {
            document.getElementById('logs').innerHTML = '';
        };

        window.runDiagnostics = async function() {
            clearLogs();
            log('å¼€å§‹è¯Šæ–­...', 'info');
            
            try {
                // 1. æ£€æŸ¥APIè¿æ¥
                log('1. æ£€æŸ¥APIè¿æ¥...', 'info');
                const response = await ConferencesAPI.getPast();
                log(`âœ“ APIå“åº”æˆåŠŸï¼ŒçŠ¶æ€: ${response.status || 'OK'}`, 'success');
                
                // 2. æ£€æŸ¥æ•°æ®
                const conferences = response.data || [];
                log(`âœ“ è·å–åˆ° ${conferences.length} ä¸ªä¼šè®®`, 'success');
                
                if (conferences.length === 0) {
                    log('âš  è­¦å‘Šï¼šæ²¡æœ‰ä¼šè®®æ•°æ®ï¼', 'warning');
                    return;
                }
                
                // 3. æ£€æŸ¥æ¯ä¸ªä¼šè®®çš„æ•°æ®
                conferences.forEach((conf, index) => {
                    log(`\nä¼šè®® ${index + 1}:`, 'info');
                    log(`  æ ‡é¢˜: ${conf.title}`, 'info');
                    log(`  image_url: ${conf.image_url || 'âŒ ç¼ºå¤±!'}`, conf.image_url ? 'success' : 'error');
                    log(`  start_date: ${conf.start_date || 'âŒ ç¼ºå¤±!'}`, conf.start_date ? 'success' : 'error');
                    log(`  end_date: ${conf.end_date || 'âŒ ç¼ºå¤±!'}`, conf.end_date ? 'success' : 'error');
                    
                    // æµ‹è¯•æ—¥æœŸæ ¼å¼åŒ–
                    if (conf.start_date && conf.end_date) {
                        try {
                            const formatted = formatDateRange(conf.start_date, conf.end_date);
                            log(`  æ ¼å¼åŒ–æ—¥æœŸ: ${formatted}`, 'success');
                        } catch (e) {
                            log(`  âŒ æ—¥æœŸæ ¼å¼åŒ–å¤±è´¥: ${e.message}`, 'error');
                        }
                    }
                });
                
                // 4. æ£€æŸ¥CSSæ–‡ä»¶
                log('\n4. æ£€æŸ¥CSSæ–‡ä»¶...', 'info');
                const cssLinks = document.querySelectorAll('link[rel="stylesheet"]');
                let antiFlickerFound = false;
                cssLinks.forEach(link => {
                    if (link.href.includes('anti-flicker')) {
                        antiFlickerFound = true;
                        log(`âœ“ æ‰¾åˆ° anti-flicker.css: ${link.href}`, 'success');
                    }
                });
                if (!antiFlickerFound) {
                    log('âš  è­¦å‘Šï¼šæœªæ‰¾åˆ° anti-flicker.cssï¼', 'warning');
                }
                
                // 5. æ£€æŸ¥å›¾ç‰‡URLå¯è®¿é—®æ€§
                log('\n5. æµ‹è¯•å›¾ç‰‡URL...', 'info');
                for (const conf of conferences.slice(0, 3)) {
                    if (conf.image_url) {
                        try {
                            const img = new Image();
                            const loadPromise = new Promise((resolve, reject) => {
                                img.onload = () => resolve(true);
                                img.onerror = () => reject(new Error('åŠ è½½å¤±è´¥'));
                                setTimeout(() => reject(new Error('è¶…æ—¶')), 5000);
                            });
                            img.src = conf.image_url;
                            await loadPromise;
                            log(`âœ“ å›¾ç‰‡åŠ è½½æˆåŠŸ: ${conf.image_url.substring(0, 50)}...`, 'success');
                        } catch (e) {
                            log(`âŒ å›¾ç‰‡åŠ è½½å¤±è´¥: ${conf.image_url.substring(0, 50)}... (${e.message})`, 'error');
                        }
                    }
                }
                
                log('\nâœ… è¯Šæ–­å®Œæˆï¼', 'success');
                
            } catch (error) {
                log(`âŒ è¯Šæ–­å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        };

        window.testImages = async function() {
            clearLogs();
            log('å¼€å§‹å›¾ç‰‡åŠ è½½æµ‹è¯•...', 'info');
            
            try {
                const response = await ConferencesAPI.getPast();
                const conferences = response.data || [];
                
                if (conferences.length === 0) {
                    log('æ²¡æœ‰æ•°æ®å¯æµ‹è¯•', 'warning');
                    return;
                }
                
                const testArea = document.getElementById('test-area');
                testArea.innerHTML = '<h2 class="text-xl text-white mb-4">å›¾ç‰‡åŠ è½½æµ‹è¯•ï¼ˆè§‚å¯Ÿæ˜¯å¦é—ªçƒï¼‰</h2>';
                
                conferences.forEach((conf, index) => {
                    const dateDisplay = formatDateRange(conf.start_date, conf.end_date);
                    
                    const card = document.createElement('div');
                    card.className = 'test-card';
                    card.innerHTML = `
                        <div class="test-img">
                            <img src="${conf.image_url}" alt="${conf.title}" loading="eager">
                        </div>
                        <div class="test-date">
                            <div style="color: #666; font-size: 14px; margin-bottom: 8px;">${dateDisplay}</div>
                            <div style="color: #333; font-weight: bold;">${conf.title}</div>
                        </div>
                    `;
                    testArea.appendChild(card);
                    
                    log(`æ¸²æŸ“å¡ç‰‡ ${index + 1}: ${conf.title}`, 'info');
                });
                
                log('âœ“ æ‰€æœ‰å¡ç‰‡å·²æ¸²æŸ“ï¼Œè¯·è§‚å¯Ÿæ˜¯å¦æœ‰é—ªçƒ', 'success');
                log('æç¤ºï¼šå¦‚æœçœ‹åˆ°é—ªçƒï¼Œå¯èƒ½æ˜¯ï¼š', 'info');
                log('  1. æµè§ˆå™¨ç¼“å­˜æœªæ¸…é™¤', 'warning');
                log('  2. CSS transition ä»åœ¨ç”Ÿæ•ˆ', 'warning');
                log('  3. å›¾ç‰‡URLæ— æ•ˆæˆ–åŠ è½½æ…¢', 'warning');
                
            } catch (error) {
                log(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // è‡ªåŠ¨è¿è¡Œè¯Šæ–­
        log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡è¯Šæ–­...', 'info');
        setTimeout(() => runDiagnostics(), 1000);
    </script>
</body>
</html>
